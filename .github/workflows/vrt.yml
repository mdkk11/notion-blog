name: VRT
on:
  deployment_status:
jobs:
  playwright:
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'
    name: VRT
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.50.1-noble
      options: --user 1001
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Screenshot Pages for Production
        run: npm run playwright:update
        env:
          BASE_URL: https://vinyl-tech.jp/
      - name: Compare Screenshot To Preview
        run: npm run playwright
        env:
          BASE_URL: ${{ github.event.deployment_status.environment_url }}
      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

  publish_report:
    name: Publish Report
    needs: [playwright]
    if: always() # テスト結果に関係なく実行
    runs-on: ubuntu-latest
    env:
      HTML_REPORT_URL_PATH: reports/${{ github.ref_name }}/${{ github.run_id }}/${{ github.run_attempt }}
    steps:
      - name: Checkout GitHub Pages Branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages

      - name: Set Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Download Test Report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: ${{ env.HTML_REPORT_URL_PATH }}

      - name: Push HTML Report
        timeout-minutes: 3
        run: |
          git add .
          git commit -m "VRT Report: ${{ github.run_id }} (attempt: ${{ github.run_attempt }})"

          for i in {1..5}; do
            git pull --rebase && git push && break || sleep 10
          done

      - name: Output Report URL
        run: |
          REPORT_URL=https://${{ github.repository_owner }}.github.io/${{ github.repository }}/${HTML_REPORT_URL_PATH}/index.html
          echo "::notice title=VRT Report::$REPORT_URL"
